"use strict";var jr=Object.create;var K=Object.defineProperty;var Nr=Object.getOwnPropertyDescriptor;var Gr=Object.getOwnPropertyNames;var Qr=Object.getPrototypeOf,$r=Object.prototype.hasOwnProperty;var y=(r,e)=>()=>(r&&(e=r(r=0)),e);var d=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Jr=(r,e)=>{for(var t in e)K(r,t,{get:e[t],enumerable:!0})},Ht=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Gr(e))!$r.call(r,i)&&i!==t&&K(r,i,{get:()=>e[i],enumerable:!(s=Nr(e,i))||s.enumerable});return r};var C=(r,e,t)=>(t=r!=null?jr(Qr(r)):{},Ht(e||!r||!r.__esModule?K(t,"default",{value:r,enumerable:!0}):t,r)),Yr=r=>Ht(K({},"__esModule",{value:!0}),r);var Re=d(Se=>{"use strict";Object.defineProperty(Se,"__esModule",{value:!0});var Ee=class{constructor(e,t,s){this.bias=e,this.backoffA=t,this.backoffB=s}next(e){let t=this.backoffA.next(e),s=this.backoffB.next(e);return t&&s&&Lt(this.bias,t,s)}};Se.CompositeBackoff=Ee;var Lt=(r,e,t)=>({get duration(){switch(r){case"a":return e.duration;case"b":return t.duration;case"max":return Math.max(t.duration,e.duration);case"min":return Math.min(t.duration,e.duration);default:throw new Error(`Unknown bias "${r}" given to CompositeBackoff`)}},next(s){let i=e.next(s),o=t.next(s);return i&&o&&Lt(r,i,o)}})});var Ae=d(ee=>{"use strict";Object.defineProperty(ee,"__esModule",{value:!0});var X=class{constructor(e,t){this.interval=e,this.limit=t}next(){return zt(this.interval,this.limit)}};ee.ConstantBackoff=X;ee.NeverRetryBackoff=new X(0,0);var zt=(r,e,t=0)=>({duration:r,next(){if(e===void 0)return this;if(!(t>=e-1))return zt(r,e,t+1)}})});var Ue=d(De=>{"use strict";Object.defineProperty(De,"__esModule",{value:!0});var _e=class{constructor(e){this.fn=e}next(e){return ke(this.fn).next(e)}};De.DelegateBackoff=_e;var ke=(r,e,t=0)=>({duration:t,next(s){let i=r(s,e);if(i!==void 0)return typeof i=="number"?ke(r,e,i):ke(r,i.state,i.delay)}})});var Ce=d(S=>{"use strict";Object.defineProperty(S,"__esModule",{value:!0});S.noJitterGenerator=(r=0,e)=>[Math.min(e.maxDelay,e.initialDelay*2**r),r+1];S.fullJitterGenerator=(r,e)=>{let[t,s]=S.noJitterGenerator(r,e);return[Math.floor(Math.random()*t),s]};S.halfJitterGenerator=(r,e)=>{let[t,s]=S.noJitterGenerator(r,e);return[Math.floor((t+Math.random()*t)/2),s]};var Vr=4,Zr=1/1.4;S.decorrelatedJitterGenerator=(r,e)=>{let[t,s]=r||[0,0],i=t+Math.random(),o=Math.pow(e.exponent,i)*Math.tanh(Math.sqrt(Vr*i)),n=Math.max(0,o-s);return[Math.min(n*Zr*e.initialDelay,e.maxDelay),[t+1,o]]}});var Nt=d(Ie=>{"use strict";Object.defineProperty(Ie,"__esModule",{value:!0});var Kr=Ce(),Wt={generator:Kr.decorrelatedJitterGenerator,maxDelay:3e4,maxAttempts:1/0,exponent:2,initialDelay:128},Fe=class{constructor(e){this.options=e?{...Wt,...e}:Wt}next(){return jt(this.options).next(void 0)}};Ie.ExponentialBackoff=Fe;var jt=(r,e,t=0,s=-1)=>({duration:t,next(){if(s>=r.maxAttempts-1)return;let[i,o]=r.generator(e,r);return jt(r,o,i,s+1)}})});var Oe=d(qe=>{"use strict";Object.defineProperty(qe,"__esModule",{value:!0});var Te=class{constructor(e){this.durations=e}next(){return Gt(this.durations,0)}};qe.IterableBackoff=Te;var Gt=(r,e)=>({duration:r[e],next:()=>e<r.length-1?Gt(r,e+1):void 0})});var Pe=d(te=>{"use strict";function I(r){for(var e in r)te.hasOwnProperty(e)||(te[e]=r[e])}Object.defineProperty(te,"__esModule",{value:!0});I(Re());I(Ae());I(Ue());I(Nt());I(Ce());I(Oe())});var re=d(Be=>{"use strict";Object.defineProperty(Be,"__esModule",{value:!0});var Me=class extends Error{constructor(e="Operation cancelled"){super(e),this.message=e,this.isTaskCancelledError=!0}};Be.TaskCancelledError=Me});var A=d(R=>{"use strict";Object.defineProperty(R,"__esModule",{value:!0});var Qt=re();R.noopDisposable={dispose:()=>{}};var Xr;(function(r){r.once=(e,t)=>{let s=!1,i;return i=e(o=>{t(o),i?i.dispose():s=!0}),s?(i.dispose(),R.noopDisposable):i},r.toPromise=(e,t)=>t?t.isCancellationRequested?Promise.reject(new Qt.TaskCancelledError):new Promise((s,i)=>{let o=r.once(e,a=>{n.dispose(),s(a)}),n=r.once(t.onCancellationRequested,()=>{o.dispose(),i(new Qt.TaskCancelledError)})}):new Promise(s=>r.once(e,s))})(Xr=R.Event||(R.Event={}));var se=class{constructor(){this.addListener=e=>this.addListenerInner(e)}get size(){return this.listeners?typeof this.listeners=="function"?1:this.listeners.length:0}emit(e){if(this.listeners)if(typeof this.listeners=="function")this.listeners(e);else for(let t of this.listeners)t(e)}addListenerInner(e){return this.listeners?typeof this.listeners=="function"?this.listeners=[this.listeners,e]:this.listeners.push(e):this.listeners=e,{dispose:()=>this.removeListener(e)}}removeListener(e){if(!this.listeners)return;if(typeof this.listeners=="function"){this.listeners===e&&(this.listeners=void 0);return}let t=this.listeners.indexOf(e);t!==-1&&(this.listeners.length===2?this.listeners=t===0?this.listeners[1]:this.listeners[0]:this.listeners=this.listeners.slice(0,t).concat(this.listeners.slice(t+1)))}};R.EventEmitter=se;var He=class extends se{constructor(){super(...arguments),this.addListener=e=>{let t=this.addListenerInner(e);return this.lastValue&&e(this.lastValue.value),t}}get hasEmitted(){return!!this.lastValue}emit(e){this.lastValue={value:e},super.emit(e)}};R.MemorizingEventEmitter=He});var x=d(ie=>{"use strict";Object.defineProperty(ie,"__esModule",{value:!0});var H=A(),Le=class{constructor(e){this.onCancel=new H.MemorizingEventEmitter,this.token=new _(this.onCancel.addListener),e&&(this.parentListener=e.onCancellationRequested(()=>this.cancel()))}cancel(){this.parentListener&&(this.parentListener.dispose(),this.parentListener=void 0),this.onCancel.hasEmitted||this.onCancel.emit()}};ie.CancellationTokenSource=Le;var _=class{constructor(e){this.onCancellationRequested=e,this.isRequested=!1,H.Event.once(e,()=>this.isRequested=!0)}get isCancellationRequested(){return this.isRequested}cancellation(e){return H.Event.toPromise(this.onCancellationRequested,e)}};ie.CancellationToken=_;_.None=new _(()=>H.noopDisposable);_.Cancelled=new _(r=>(r(void 0),H.noopDisposable))});var T=d(ne=>{"use strict";Object.defineProperty(ne,"__esModule",{value:!0});var $t=A();ne.returnOrThrow=r=>{if("error"in r)throw r.error;return"success"in r?r.success:r.value};var es=()=>{if(typeof performance<"u"){let r=performance.now();return()=>performance.now()-r}else{let r=process.hrtime.bigint();return()=>Number(process.hrtime.bigint()-r)/1e6}},L=class{constructor(e=()=>!1,t=()=>!1){this.errorFilter=e,this.resultFilter=t,this.successEmitter=new $t.EventEmitter,this.failureEmitter=new $t.EventEmitter,this.onSuccess=this.successEmitter.addListener,this.onFailure=this.failureEmitter.addListener}derive(){let e=new L(this.errorFilter,this.resultFilter);return e.onSuccess(t=>this.successEmitter.emit(t)),e.onFailure(t=>this.failureEmitter.emit(t)),e}async invoke(e,...t){let s=this.successEmitter.size||this.failureEmitter.size?es():null;try{let i=await e(...t);return this.resultFilter(i)?(s&&this.failureEmitter.emit({duration:s(),handled:!0,reason:{value:i}}),{value:i}):(s&&this.successEmitter.emit({duration:s()}),{success:i})}catch(i){let o=this.errorFilter(i);if(s&&this.failureEmitter.emit({duration:s(),handled:o,reason:{error:i}}),!o)throw i;return{error:i}}}};ne.ExecuteWrapper=L});var je=d(We=>{"use strict";Object.defineProperty(We,"__esModule",{value:!0});var ze=class extends Error{constructor(e="Execution prevented because the circuit breaker is open"){super(e),this.isBrokenCircuitError=!0}};We.BrokenCircuitError=ze});var Qe=d(Ge=>{"use strict";Object.defineProperty(Ge,"__esModule",{value:!0});var Ne=class extends Error{constructor(e,t){super(`Bulkhead capacity exceeded (0/${e} execution slots, 0/${t} available)`),this.isBulkheadRejectedError=!0}};Ge.BulkheadRejectedError=Ne});var Ye=d(Je=>{"use strict";Object.defineProperty(Je,"__esModule",{value:!0});var ts=je(),$e=class extends ts.BrokenCircuitError{constructor(){super("Execution prevented because the circuit breaker is open"),this.isIsolatedCircuitError=!0}};Je.IsolatedCircuitError=$e});var ae=d(k=>{"use strict";function oe(r){for(var e in r)k.hasOwnProperty(e)||(k[e]=r[e])}Object.defineProperty(k,"__esModule",{value:!0});oe(je());oe(Qe());oe(Ye());oe(re());k.isBrokenCircuitError=r=>!!r&&r instanceof Error&&"isBrokenCircuitError"in r;k.isBulkheadRejectedError=r=>!!r&&r instanceof Error&&"isBulkheadRejectedError"in r;k.isIsolatedCircuitError=r=>!!r&&r instanceof Error&&"isBulkheadRejectedError"in r;k.isTaskCancelledError=r=>!!r&&r instanceof Error&&"isBulkheadRejectedError"in r});var ue=d(z=>{"use strict";Object.defineProperty(z,"__esModule",{value:!0});var rs=x(),ce=A(),Jt=T(),Yt=ae(),ss=Ye(),f;(function(r){r[r.Closed=0]="Closed",r[r.Open=1]="Open",r[r.HalfOpen=2]="HalfOpen",r[r.Isolated=3]="Isolated"})(f=z.CircuitState||(z.CircuitState={}));var Ve=class{constructor(e,t){this.options=e,this.executor=t,this.breakEmitter=new ce.EventEmitter,this.resetEmitter=new ce.EventEmitter,this.halfOpenEmitter=new ce.EventEmitter,this.stateChangeEmitter=new ce.EventEmitter,this.innerState={value:f.Closed},this.onBreak=this.breakEmitter.addListener,this.onReset=this.resetEmitter.addListener,this.onHalfOpen=this.halfOpenEmitter.addListener,this.onStateChange=this.stateChangeEmitter.addListener,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure}get state(){return this.innerState.value}get lastFailure(){return this.innerLastFailure}isolate(){this.innerState.value!==f.Isolated&&(this.innerState={value:f.Isolated,counters:0},this.breakEmitter.emit({isolated:!0}),this.stateChangeEmitter.emit(f.Isolated)),this.innerState.counters++;let e=!1;return{dispose:()=>{e||(e=!0,this.innerState.value===f.Isolated&&!--this.innerState.counters&&(this.innerState={value:f.Closed},this.resetEmitter.emit(),this.stateChangeEmitter.emit(f.Closed)))}}}async execute(e,t=rs.CancellationToken.None){let s=this.innerState;switch(s.value){case f.Closed:let i=await this.executor.invoke(e,{cancellationToken:t});return"success"in i?this.options.breaker.success(s.value):(this.innerLastFailure=i,this.options.breaker.failure(s.value)&&this.open(i)),Jt.returnOrThrow(i);case f.HalfOpen:if(await s.test.catch(()=>{}),this.state===f.Closed&&t.isCancellationRequested)throw new Yt.TaskCancelledError;return this.execute(e);case f.Open:if(Date.now()-s.openedAt<this.options.halfOpenAfter)throw new Yt.BrokenCircuitError;let o=this.halfOpen(e,t);return this.innerState={value:f.HalfOpen,test:o},this.stateChangeEmitter.emit(f.HalfOpen),o;case f.Isolated:throw new ss.IsolatedCircuitError;default:throw new Error(`Unexpected circuit state ${s}`)}}async halfOpen(e,t){this.halfOpenEmitter.emit();try{let s=await this.executor.invoke(e,{cancellationToken:t});return"success"in s?(this.options.breaker.success(f.HalfOpen),this.close()):(this.innerLastFailure=s,this.options.breaker.failure(f.HalfOpen),this.open(s)),Jt.returnOrThrow(s)}catch(s){throw this.close(),s}}open(e){this.state===f.Isolated||this.state===f.Open||(this.innerState={value:f.Open,openedAt:Date.now()},this.breakEmitter.emit(e),this.stateChangeEmitter.emit(f.Open))}close(){this.state===f.HalfOpen&&(this.innerState={value:f.Closed},this.resetEmitter.emit(),this.stateChangeEmitter.emit(f.Closed))}};z.CircuitBreakerPolicy=Ve});var Zt=d(Ke=>{"use strict";Object.defineProperty(Ke,"__esModule",{value:!0});var Vt=ue(),Ze=class{constructor({threshold:e,duration:t,minimumRps:s}){if(this.windows=[],this.currentWindow=0,this.currentFailures=0,this.currentSuccesses=0,e<=0||e>=1)throw new RangeError(`SamplingBreaker threshold should be between (0, 1), got ${e}`);this.threshold=e;let i=Math.max(5,Math.ceil(t/1e3));for(let o=0;o<i;o++)this.windows.push({startedAt:0,failures:0,successes:0});this.windowSize=Math.round(t/i),this.duration=this.windowSize*i,s?this.minimumRpms=s/1e3:this.minimumRpms=5/(e*1e3)}success(e){e===Vt.CircuitState.HalfOpen&&this.resetWindows(),this.push(!0)}failure(e){if(this.push(!1),e!==Vt.CircuitState.Closed)return!0;let t=this.currentSuccesses+this.currentFailures;return t<this.duration*this.minimumRpms?!1:this.currentFailures>this.threshold*t}resetWindows(){this.currentFailures=0,this.currentSuccesses=0;for(let e of this.windows)e.failures=0,e.successes=0,e.startedAt=0}rotateWindow(e){let t=(this.currentWindow+1)%this.windows.length;this.currentFailures-=this.windows[t].failures,this.currentSuccesses-=this.windows[t].successes;let s=this.windows[t]={failures:0,successes:0,startedAt:e};return this.currentWindow=t,s}push(e){let t=Date.now(),s=this.windows[this.currentWindow];t-s.startedAt>=this.windowSize&&(s=this.rotateWindow(t)),e?(s.successes++,this.currentSuccesses++):(s.failures++,this.currentFailures++)}};Ke.SamplingBreaker=Ze});var Kt=d(et=>{"use strict";Object.defineProperty(et,"__esModule",{value:!0});var Xe=class{constructor(e){this.threshold=e,this.count=0}success(){this.count=0}failure(){return++this.count>=this.threshold}};et.ConsecutiveBreaker=Xe});var er=d(le=>{"use strict";function Xt(r){for(var e in r)le.hasOwnProperty(e)||(le[e]=r[e])}Object.defineProperty(le,"__esModule",{value:!0});Xt(Zt());Xt(Kt())});var tr=d(tt=>{"use strict";Object.defineProperty(tt,"__esModule",{value:!0});tt.defer=()=>{let r,e,t=new Promise((s,i)=>{r=s,e=i});return{resolve:r,reject:e,promise:t}}});var nt=d(st=>{"use strict";Object.defineProperty(st,"__esModule",{value:!0});var is=x(),ns=tr(),os=A(),as=T(),cs=Qe(),us=ae(),rt=class{constructor(e,t){this.capacity=e,this.queueCapacity=t,this.active=0,this.queue=[],this.onRejectEmitter=new os.EventEmitter,this.executor=new as.ExecuteWrapper,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure,this.onReject=this.onRejectEmitter.addListener}get executionSlots(){return this.capacity-this.active}get queueSlots(){return this.queueCapacity-this.queue.length}async execute(e,t=is.CancellationToken.None){if(t.isCancellationRequested)throw new us.TaskCancelledError;if(this.active<this.capacity){this.active++;try{return await e({cancellationToken:t})}finally{this.active--,this.dequeue()}}if(this.queue.length<this.queueCapacity){let{resolve:s,reject:i,promise:o}=ns.defer();return this.queue.push({ct:t,fn:e,resolve:s,reject:i}),o}throw this.onRejectEmitter.emit(),new cs.BulkheadRejectedError(this.capacity,this.queueCapacity)}dequeue(){let e=this.queue.shift();!e||Promise.resolve().then(()=>this.execute(e.fn,e.ct)).then(e.resolve).catch(e.reject)}};st.BulkheadPolicy=rt});var ct=d(at=>{"use strict";Object.defineProperty(at,"__esModule",{value:!0});var ls=x(),ot=class{constructor(e,t){this.executor=e,this.value=t,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure}async execute(e,t=ls.CancellationToken.None){let s=await this.executor.invoke(e,{cancellationToken:t});return"success"in s?s.success:this.value()}};at.FallbackPolicy=ot});var dt=d(lt=>{"use strict";Object.defineProperty(lt,"__esModule",{value:!0});var ds=x(),rr=T(),ut=class{constructor(){this.executor=new rr.ExecuteWrapper,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure}async execute(e,t=ds.CancellationToken.None){return rr.returnOrThrow(await this.executor.invoke(e,{cancellationToken:t}))}};lt.NoopPolicy=ut});var ht=d(ft=>{"use strict";Object.defineProperty(ft,"__esModule",{value:!0});var ps=Pe(),fs=Re(),pt=Ae(),hs=Ue(),ms=Oe(),ys=x(),sr=A(),vs=(r,e)=>new Promise(t=>{let s=setTimeout(t,r);e&&s.unref()}),W=class{constructor(e,t){this.options=e,this.executor=t,this.onGiveUpEmitter=new sr.EventEmitter,this.onRetryEmitter=new sr.EventEmitter,this.onSuccess=this.executor.onSuccess,this.onFailure=this.executor.onFailure,this.onRetry=this.onRetryEmitter.addListener,this.onGiveUp=this.onGiveUpEmitter.addListener}attempts(e){return this.composeBackoff("a",new pt.ConstantBackoff(1,e))}delay(e){return this.composeBackoff("b",typeof e=="number"?new pt.ConstantBackoff(e):new ms.IterableBackoff(e))}delegate(e){return this.composeBackoff("b",new hs.DelegateBackoff(e))}exponential(e={}){return this.composeBackoff("b",new ps.ExponentialBackoff(e))}backoff(e){return this.composeBackoff("b",e)}dangerouslyUnref(){return this.derivePolicy({...this.options,unref:!0})}async execute(e,t=ys.CancellationToken.None){let s=this.options.backoff||new pt.ConstantBackoff(0,1),i;for(let o=0;;o++){let n=await this.executor.invoke(e,{attempt:o,cancellationToken:t});if("success"in n)return n.success;if(!t.isCancellationRequested){let a={attempt:o+1,cancellationToken:t,result:n};if(o===0?i=s.next(a):i&&(i=i.next(a)),i){let c=i.duration,u=vs(c,!!this.options.unref);this.onRetryEmitter.emit({...n,delay:c}),await u;continue}}if(this.onGiveUpEmitter.emit(n),"error"in n)throw n.error;return n.value}}composeBackoff(e,t){return this.options.backoff&&(t=new fs.CompositeBackoff(e,this.options.backoff,t)),this.derivePolicy({...this.options,backoff:t})}derivePolicy(e){let t=new W(e,this.executor.derive());return t.onRetry(s=>this.onRetryEmitter.emit(s)),t}};ft.RetryPolicy=W});var yt=d(N=>{"use strict";Object.defineProperty(N,"__esModule",{value:!0});var ir=x(),bs=A(),mt=T(),ws=re(),nr;(function(r){r.Cooperative="optimistic",r.Aggressive="aggressive"})(nr=N.TimeoutStrategy||(N.TimeoutStrategy={}));var j=class{constructor(e,t,s=new mt.ExecuteWrapper,i=!1){this.duration=e,this.strategy=t,this.executor=s,this.unref=i,this.timeoutEmitter=new bs.EventEmitter,this.onTimeout=this.timeoutEmitter.addListener,this.onFailure=this.executor.onFailure,this.onSuccess=this.executor.onSuccess}dangerouslyUnref(){return new j(this.duration,this.strategy,this.executor,!0)}async execute(e,t=ir.CancellationToken.None){let s=new ir.CancellationTokenSource(t),i=setTimeout(()=>s.cancel(),this.duration);this.unref&&i.unref();let o={cancellation:s.token,cancellationToken:s.token},n=s.token.onCancellationRequested(()=>this.timeoutEmitter.emit());try{return this.strategy===nr.Cooperative?mt.returnOrThrow(await this.executor.invoke(e,o,s.token)):await this.executor.invoke(async()=>Promise.race([Promise.resolve(e(o,s.token)),s.token.cancellation(s.token).then(()=>{throw new ws.TaskCancelledError(`Operation timed out after ${this.duration}ms`)})])).then(mt.returnOrThrow)}finally{n.dispose(),s.cancel(),clearTimeout(i)}}};N.TimeoutPolicy=j});var or=d(bt=>{"use strict";Object.defineProperty(bt,"__esModule",{value:!0});var gs=nt(),xs=x(),Es=ue(),vt=T(),Ss=ct(),Rs=dt(),As=ht(),_s=yt(),de=(r,e)=>e?t=>t instanceof r&&e(t):t=>t instanceof r,ks=()=>!0,G=()=>!1,v=class{constructor(e){this.options=e}static wrap(...e){return{onFailure:e[0].onFailure,onSuccess:e[0].onSuccess,execute(t,s){let i=(o,n)=>n===e.length?t(o):e[n].execute(a=>i({...o,...a},n+1),o.cancellationToken);return Promise.resolve(i({cancellationToken:s},0))}}}static bulkhead(e,t=0){return new gs.BulkheadPolicy(e,t)}static handleAll(){return new v({errorFilter:ks,resultFilter:G})}static handleType(e,t){return new v({errorFilter:de(e,t),resultFilter:G})}static handleWhen(e){return new v({errorFilter:e,resultFilter:G})}static handleResultType(e,t){return new v({errorFilter:G,resultFilter:de(e,t)})}static handleWhenResult(e){return new v({errorFilter:G,resultFilter:e})}static timeout(e,t){return new _s.TimeoutPolicy(e,t)}static use(e){return(t,s,i)=>{let o=i.value;if(typeof o!="function")throw new Error(`Can only decorate functions with @cockatiel, got ${typeof o}`);i.value=function(...n){let a=n[n.length-1]instanceof xs.CancellationToken?n.pop():void 0;return e.execute(c=>o.apply(this,[...n,c]),a)}}}orType(e,t){let s=de(e,t);return new v({...this.options,errorFilter:i=>this.options.errorFilter(i)||s(i)})}orWhen(e){return new v({...this.options,errorFilter:t=>this.options.errorFilter(t)||e(t)})}orWhenResult(e){return new v({...this.options,resultFilter:t=>this.options.resultFilter(t)||e(t)})}orResultType(e,t){let s=de(e,t);return new v({...this.options,resultFilter:i=>this.options.resultFilter(i)||s(i)})}retry(){return new As.RetryPolicy({},new vt.ExecuteWrapper(this.options.errorFilter,this.options.resultFilter))}circuitBreaker(e,t){return new Es.CircuitBreakerPolicy({breaker:t,halfOpenAfter:e},new vt.ExecuteWrapper(this.options.errorFilter,this.options.resultFilter))}fallback(e){return new Ss.FallbackPolicy(new vt.ExecuteWrapper(this.options.errorFilter,this.options.resultFilter),typeof e=="function"?e:()=>e)}};bt.Policy=v;v.noop=new Rs.NoopPolicy});var wt=d(q=>{"use strict";function b(r){for(var e in r)q.hasOwnProperty(e)||(q[e]=r[e])}Object.defineProperty(q,"__esModule",{value:!0});b(Pe());b(er());b(nt());b(x());b(ue());var ar=A();q.Event=ar.Event;q.EventEmitter=ar.EventEmitter;b(ae());b(ct());b(dt());b(or());b(ht());b(yt())});var cr,ur=y(()=>{"use strict";cr=r=>(e,t)=>{let s,i=0,o=t.length-1;for(;i<=o;)s=Math.floor((i+o)/2),r(t[s])>=e?o=s-1:i=s+1;return i}});var pe,gt,lr=y(()=>{"use strict";pe=Symbol("unset"),gt=r=>{let e=pe,t=()=>(e===pe&&(e=r()),e);return t.getValue=()=>e===pe?void 0:e,t.forget=()=>{e=pe},t}});async function*Us(r,e,t=0,s=1024){let i=new Uint8Array(s);for(let o=0;o<e.length;o++){let n=e[o];if(n.op===1)continue;if(n.op===2){let u=n.offset+n.value.length-t;if(u<=0)continue;let p=u<n.value.length?n.value.subarray(-u):n.value;p.length>0&&(yield p);continue}let a=n.roffset+(o+1<e.length?e[o+1].offset:1/0)-n.offset,c=n.roffset+Math.max(0,t-n.offset);for(;c<a;){let u=await r.read(c,i.subarray(0,Math.min(i.length,a-c)));if(u===0)break;yield i.subarray(0,u),c+=u}}}var dr,Ds,E,Cs,O=y(()=>{"use strict";dr=C(wt());ur();lr();Ds=r=>r.op===0?{...r,op:1,previous:r.value}:r.op===1?{...r,op:0,value:r.previous}:{...r,value:r.previous,previous:r.value},E=class{constructor(e){this.saveGuard=dr.Policy.bulkhead(1,1/0);this._unsavedEditIndex=0;this.getSizeInner=gt(()=>this.accessor.getSize());this.getEditTimeline=gt(()=>Cs(this._edits));this._edits=e.edits?e.edits.saved.concat(e.edits.unsaved):[],this._unsavedEditIndex=e.edits?.saved.length??0,this.supportsLengthChanges=e.supportsLengthChanges,this.isFiniteSize=e.isFiniteSize,this.accessor=e.accessor,this.pageSize=e.accessor.pageSize}get uri(){return this.accessor.uri}get isReadonly(){return!!this.accessor.isReadonly}async size(){if(!this.isFiniteSize)return;let e=await this.getSizeInner();if(e===void 0)return;let{sizeDelta:t}=this.getEditTimeline();return e+t}get edits(){return this._edits}get unsavedEdits(){return this._edits.slice(this.unsavedEditIndex)}get unsavedEditIndex(){return this._unsavedEditIndex}get isSynced(){return this.unsavedEditIndex===this.edits.length}readInto(e,t){return this.accessor.read(e,t)}readWithEdits(e=0,t=128*1024){return Us(this.accessor,this.getEditTimeline().ranges,e,t)}save(){let e=this._edits.slice(this.unsavedEditIndex);return e.length===0?Promise.resolve():(this._unsavedEditIndex+=e.length,this.saveGuard.execute(async()=>{e.some(t=>t.op!==2||t.previous.length!==t.value.length)?await this.accessor.writeStream(this.readWithEdits()):await this.accessor.writeBulk(e.map(t=>({offset:t.offset,data:t.value}))),this.getSizeInner.forget()}))}revert(){this._unsavedEditIndex=0,this._edits=[],this.accessor.invalidate?.(),this.getEditTimeline.forget(),this.getSizeInner.forget()}makeEdits(e){let t=this._edits.length;return this._edits.push(...e),this.getEditTimeline.forget(),{undo:()=>(this.unsavedEditIndex<=t?this._edits.splice(t,e.length):this._edits.push(...e.map(Ds)),this.getEditTimeline.forget(),this._edits),redo:()=>(this._edits.push(...e),this.getEditTimeline.forget(),this._edits)}}dispose(){this.accessor.dispose()}};Cs=r=>{let e=[{op:0,editIndex:-1,roffset:0,offset:0}],t=(n,a,c)=>a.op===0?{before:{op:0,editIndex:n,roffset:a.roffset,offset:a.offset},after:{op:0,editIndex:n,roffset:a.roffset+c,offset:a.offset+c}}:a.op===1?{before:{op:1,editIndex:n,offset:a.offset},after:{op:1,editIndex:n,offset:a.offset+c}}:{before:{op:2,editIndex:n,offset:a.offset,value:a.value.subarray(0,c)},after:{op:2,editIndex:n,offset:a.offset+c,value:a.value.subarray(c)}},s=cr(n=>n.offset),i=0,o=(n,a)=>{for(i+=a;n<e.length;n++)e[n].offset+=a};for(let n=0;n<r.length;n++){let a=r[n],c=s(a.offset,e);(c===e.length||e[c].offset>a.offset)&&c--;let u=e[c];if(a.op===0){let{before:p,after:l}=t(n,u,a.offset-u.offset);e.splice(c,1,p,{op:2,editIndex:n,offset:a.offset,value:a.value},l),o(c+2,a.value.length)}else if(a.op===1||a.op===2){let{before:p}=t(n,u,a.offset-u.offset),l=s(a.offset+a.previous.length,e);(l===e.length||e[l].offset>a.offset)&&l--;let{after:m}=t(n,e[l],a.offset+a.previous.length-e[l].offset);e.splice(c,l-c+1,p,a.op===2?{op:2,editIndex:n,offset:a.offset,value:a.value}:{op:1,editIndex:n,offset:a.offset},m),o(c+2,(a.op===2?a.value.length:0)-a.previous.length)}}return{ranges:e,sizeDelta:i}}});var Fs,Is,me,Mi,Bi,Ts,Q,fe,qs,he,pr,Os,hr,Ps,Ms,fr,mr,Bs,Hs,Ls,yr,zs,vr=y(()=>{Fs=typeof atob=="function",Is=typeof btoa=="function",me=typeof Buffer=="function",Mi=typeof TextDecoder=="function"?new TextDecoder:void 0,Bi=typeof TextEncoder=="function"?new TextEncoder:void 0,Ts="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",Q=Array.prototype.slice.call(Ts),fe=(r=>{let e={};return r.forEach((t,s)=>e[t]=s),e})(Q),qs=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,he=String.fromCharCode.bind(String),pr=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):(r,e=t=>t)=>new Uint8Array(Array.prototype.slice.call(r,0).map(e)),Os=r=>r.replace(/=/g,"").replace(/[+\/]/g,e=>e=="+"?"-":"_"),hr=r=>r.replace(/[^A-Za-z0-9\+\/]/g,""),Ps=r=>{let e,t,s,i,o="",n=r.length%3;for(let a=0;a<r.length;){if((t=r.charCodeAt(a++))>255||(s=r.charCodeAt(a++))>255||(i=r.charCodeAt(a++))>255)throw new TypeError("invalid character found");e=t<<16|s<<8|i,o+=Q[e>>18&63]+Q[e>>12&63]+Q[e>>6&63]+Q[e&63]}return n?o.slice(0,n-3)+"===".substring(n):o},Ms=Is?r=>btoa(r):me?r=>Buffer.from(r,"binary").toString("base64"):Ps,fr=me?r=>Buffer.from(r).toString("base64"):r=>{let t=[];for(let s=0,i=r.length;s<i;s+=4096)t.push(he.apply(null,r.subarray(s,s+4096)));return Ms(t.join(""))},mr=(r,e=!1)=>e?Os(fr(r)):fr(r),Bs=r=>{if(r=r.replace(/\s+/g,""),!qs.test(r))throw new TypeError("malformed base64.");r+="==".slice(2-(r.length&3));let e,t="",s,i;for(let o=0;o<r.length;)e=fe[r.charAt(o++)]<<18|fe[r.charAt(o++)]<<12|(s=fe[r.charAt(o++)])<<6|(i=fe[r.charAt(o++)]),t+=s===64?he(e>>16&255):i===64?he(e>>16&255,e>>8&255):he(e>>16&255,e>>8&255,e&255);return t},Hs=Fs?r=>atob(hr(r)):me?r=>Buffer.from(r,"base64").toString("binary"):Bs,Ls=me?r=>pr(Buffer.from(r,"base64")):r=>pr(Hs(r),e=>e.charCodeAt(0)),yr=r=>Ls(zs(r)),zs=r=>hr(r.replace(/[-_]/g,e=>e=="-"?"+":"/"))});var xt,js,Ns,F,Et=y(()=>{"use strict";vr();xt=C(require("vscode")),js=new TextEncoder,Ns=new TextDecoder,F=class{constructor(e){this.uri=e}async write(e){let t=JSON.stringify(e,(s,i)=>i instanceof Uint8Array?{$u8:mr(i)}:i);await xt.workspace.fs.writeFile(this.uri,js.encode(t))}async read(){let e;try{e=Ns.decode(await xt.workspace.fs.readFile(this.uri))}catch{return[]}return JSON.parse(e,(t,s)=>s&&typeof s=="object"&&"$u8"in s?yr(s.$u8):s)}}});var br,h,$,St,Gs,wr,Rt,ye,At,_t,kt,Dt=y(()=>{"use strict";br=C(wt()),h=C(require("vscode")),$=async(r,e)=>{if(r.scheme==="untitled")return new At(r,e??new Uint8Array);if(r.scheme==="vscode-debug-memory"){let{permissions:t=0}=await h.workspace.fs.stat(r);return new _t(r,!!(t&h.FilePermission.Readonly))}if(r.scheme==="file")try{let t=require("fs");if((await t.promises.stat(r.fsPath)).isFile())return new Rt(r,t)}catch{}return new ye(r)},St=class{constructor(e,t){this.path=e;this._fs=t;this.borrowQueue=[];this.disposed=!1}borrow(e){return this.disposed?Promise.reject(new Error("FileHandle was disposed")):new Promise((t,s)=>{this.borrowQueue.push(async i=>{if(i instanceof Error)return s(i);try{t(await e(i))}catch(o){s(o)}}),this.borrowQueue.length===1&&this.process()})}dispose(){this.disposed=!0,this.handle=void 0,this.disposeTimeout&&clearTimeout(this.disposeTimeout),this.rejectAll(new Error("FileHandle was disposed"))}async close(){await this.handle?.close(),this.handle=void 0,this.disposeTimeout&&clearTimeout(this.disposeTimeout)}rejectAll(e){for(;this.borrowQueue.length;)this.borrowQueue.pop()(e)}async process(){for(this.disposeTimeout&&clearTimeout(this.disposeTimeout);this.borrowQueue.length;){if(!this.handle)try{this.handle=await this._fs.promises.open(this.path,this._fs.constants.O_RDWR|this._fs.constants.O_CREAT)}catch(e){return this.rejectAll(e)}await this.borrowQueue[0]?.(this.handle),this.borrowQueue.shift()}this.handle&&(this.disposeTimeout=setTimeout(()=>{this.handle?.close(),this.handle=void 0},1e3))}},Gs=br.Policy.handleWhen(r=>r.code==="ENOENT").retry().attempts(10).delay(50),wr=128*1024,Rt=class{constructor(e,t){this.fs=t;this.supportsIncremetalAccess=!0;this.pageSize=wr;this.uri=e.toString(),this.handle=new St(e.fsPath,t)}watch(e,t){return kt(this.uri,e,t)}async getSize(){return this.handle.borrow(async e=>(await e.stat()).size)}async read(e,t){return this.handle.borrow(async s=>{let{bytesRead:i}=await s.read(t,0,t.byteLength,e);return i})}writeBulk(e){return this.handle.borrow(async t=>{for(let{data:s,offset:i}of e)t.write(s,0,s.byteLength,i)})}async writeStream(e,t){let s=`${this.handle.path}.tmp`,i=await this.fs.promises.open(s,this.fs.constants.O_WRONLY|this.fs.constants.O_CREAT|this.fs.constants.O_TRUNC);try{let o=0;for await(let n of e){if(t?.isCancellationRequested)return;await i.write(n,0,n.byteLength,o),o+=n.byteLength}}finally{await i.close()}return await this.handle.borrow(async()=>{await this.handle.close(),await Gs.execute(()=>this.fs.promises.rename(s,this.handle.path))}),this.handle.borrow(async o=>{if(t?.isCancellationRequested)return;let n=0;for await(let a of e){if(t?.isCancellationRequested)return;await o.write(a,0,a.byteLength,n),n+=a.byteLength}})}dispose(){this.handle.dispose()}},ye=class{constructor(e){this.pageSize=wr;this.uri=e.toString(),this.fsPath=e.fsPath,this.isReadonly=h.workspace.fs.isWritableFileSystem(this.uri)===!1}watch(e,t){return kt(this.uri,e,t)}async getSize(){return(await h.workspace.fs.stat(h.Uri.parse(this.uri))).size}async read(e,t){let s=await this.getContents(),i=Math.min(t.length,s.length-e);return t.set(s.subarray(e,i+e)),i}async writeStream(e,t){let s=0,i=[];for await(let a of e){if(t?.isCancellationRequested)throw new h.CancellationError;i.push(a),s+=a.length}let o=new Uint8Array(s),n=0;for(let a of i)o.set(a,n),n+=a.length;await h.workspace.fs.writeFile(h.Uri.parse(this.uri),o)}async writeBulk(e){let t=await this.getContents();for(let{data:s,offset:i}of e)t.set(s,i);return h.workspace.fs.writeFile(h.Uri.parse(this.uri),t)}invalidate(){this.contents=void 0}dispose(){this.contents=void 0}getContents(){return this.contents??(this.contents=h.workspace.fs.readFile(h.Uri.parse(this.uri))),this.contents}},At=class extends ye{constructor(t,s){super(t);this.contents=s}getSize(){return Promise.resolve(this.contents.byteLength)}},_t=class{constructor(e,t){this.isReadonly=t;this.supportsIncremetalAccess=!0;this.pageSize=4*1024;this.uri=e.toString()}watch(e,t){return kt(this.uri,e,t)}async getSize(){}async read(e,t){let s=await h.workspace.fs.readFile(this.referenceRange(e,e+t.length)),i=Math.min(t.length,s.length);return t.set(s.subarray(0,i)),i}async writeStream(){throw new Error("Not supported")}async writeBulk(e){await Promise.all(e.map(t=>h.workspace.fs.writeFile(this.referenceRange(t.offset,t.offset+t.data.length),t.data)))}referenceRange(e,t){return h.Uri.parse(this.uri).with({query:`?range=${e}:${t}`})}invalidate(){}dispose(){}},kt=(r,e,t)=>{let s=r.split("/"),i=s.pop(),o=new h.RelativePattern(h.Uri.parse(s.join("/")),i),n=h.workspace.createFileSystemWatcher(o);return n.onDidChange(e),n.onDidDelete(t),n}});var ve,gr,xr,Ct,Er,Ut,Ft,be,Sr,we=y(()=>{"use strict";ve=require("crypto"),gr=require("os"),xr=require("path"),Ct=require("fs");Dt();Er=C(require("vscode")),Ut=[],Ft=async r=>{let e=(0,xr.join)((0,gr.tmpdir)(),`vscode-hexeditor-test-${(0,ve.randomBytes)(8).toString("hex")}.bin`);return Ut.push(e),r&&await Ct.promises.writeFile(e,r),Er.Uri.file(e)},be=async r=>$(await Ft(r));afterEach(async()=>{await Promise.all(Ut.map(Ct.promises.unlink)),Ut=[]});Sr=r=>()=>{let e=(0,ve.createHash)("md5").update(r).digest();return r=e,e.readUInt32BE()/4294967295}});var Qs={};var Rr,Ar=y(()=>{"use strict";Rr=require("chai");O();Et();we();describe("Backup",()=>{let r=[{op:1,offset:3,previous:new Uint8Array([3,4,5])},{op:2,offset:1,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,6])}];it("round trips",async()=>{let e=new F(await Ft());await e.write(r),(0,Rr.expect)(await e.read()).to.deep.equal(r)})})});function $s(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}function Js(r,e=0){e=kr(149417,e);for(let t=0,s=r.length;t<s;t++)e=kr(r[t],e);return e}function kr(r,e){return(e<<5)-e+r|0}var _r,P,Tt=y(()=>{"use strict";_r=r=>typeof r=="function"?r():r,P=class{constructor(){this.table=new Map}set(e,t){let s=Js(e),i=this.table.get(s);if(!i){let n={buf:e,value:_r(t)};return this.table.set(s,[n]),n.value}for(let n of i)if($s(n.buf,e))return n.value;let o={buf:e,value:_r(t)};return i.push(o),o.value}*entries(){for(let e of this.table.values())for(let{buf:t,value:s}of e)yield[t,s]}*keys(){for(let e of this.table.values())for(let{buf:t}of e)yield t}*values(){for(let e of this.table.values())for(let{value:t}of e)yield t}}});var Dr,Ur,Cr=y(()=>{"use strict";O();Tt();Dr=r=>{let e=0,t=new P,s=n=>({offset:t.set(n,()=>{let c=e;return e+=n.length,c}),len:n.length}),i=[];for(let n of r)n.op===0?i.push({...n,value:s(n.value)}):n.op===1?i.push({...n,previous:s(n.previous)}):i.push({...n,previous:s(n.previous),value:s(n.value)});let o=new Uint8Array(e);for(let[n,a]of t.entries())o.set(n,a);return{data:o,edits:i}},Ur=({edits:r,data:e})=>{let t=({offset:s,len:i})=>e.slice(s,s+i);return r.map(s=>s.op===0?{...s,value:t(s.value)}:s.op===1?{...s,previous:t(s.previous)}:{...s,previous:t(s.previous),value:t(s.value)})}});var Ys={};var M,Fr=y(()=>{"use strict";M=require("chai");O();Cr();we();describe("HexDocumentModel",()=>{let r=[0,1,2,3,4,5,6,7,8,9],e;beforeEach(async()=>{e=new E({accessor:await be(new Uint8Array(r)),supportsLengthChanges:!1,isFiniteSize:!0})}),describe("edit timeline",()=>{it("keeps offsets in replacements",()=>{e.makeEdits([{op:2,offset:6,value:new Uint8Array([16]),previous:new Uint8Array([6,7,8])},{op:2,offset:1,value:new Uint8Array([11]),previous:new Uint8Array([1,2,3])}]);let t=e.getEditTimeline();(0,M.expect)(t).to.deep.equal({sizeDelta:-4,ranges:[{op:0,editIndex:1,roffset:0,offset:0},{op:2,editIndex:1,offset:1,value:new Uint8Array([11])},{op:0,editIndex:1,roffset:4,offset:2},{op:2,editIndex:0,offset:4,value:new Uint8Array([16])},{op:0,editIndex:0,roffset:9,offset:5}]})})}),describe("serialization",()=>{it("round trips",()=>{let t=[{op:0,offset:2,value:new Uint8Array([10,11,12])},{op:2,offset:2,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,3])},{op:1,offset:3,previous:new Uint8Array([3,4,5])}],s=Dr(t);(0,M.expect)(Ur(s)).to.deep.equal(t),(0,M.expect)(s.data.length).to.equal(9)})}),describe("edit reading",()=>{let t=async s=>{for(let i=0;i<s.length;i++){let o=new Uint8Array;for await(let n of e.readWithEdits(i))o=Buffer.concat([o,n]);(0,M.expect)(o).to.deep.equal(Buffer.from(s.subarray(i)),`expected to be equal at offset ${i}`)}(0,M.expect)(await e.size()).to.equal(s.length)};it("reads file verbatim",async()=>{await t(new Uint8Array(r))}),it("reads with a simple insert",async()=>{e.makeEdits([{op:0,offset:2,value:new Uint8Array([10,11,12])}]),await t(new Uint8Array([0,1,10,11,12,2,3,4,5,6,7,8,9]))}),it("reads with a simple delete",async()=>{e.makeEdits([{op:1,offset:2,previous:new Uint8Array([2,3,4])}]),await t(new Uint8Array([0,1,5,6,7,8,9]))}),it("reads with a simple replace",async()=>{e.makeEdits([{op:2,offset:2,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,3])}]),await t(new Uint8Array([0,1,10,11,12,5,6,7,8,9]))}),it("replaces at beginning",async()=>{e.makeEdits([{op:2,offset:0,value:new Uint8Array([10,11,12]),previous:new Uint8Array([0,1,2])}]),await t(new Uint8Array([10,11,12,3,4,5,6,7,8,9]))}),it("makes random replacements",async function(){this.timeout(1e4);let s=new Uint8Array(r),i=Sr("vs code!"),o=`- [${s.join(", ")}]
`,n=0;for(let a=0;a<1e3;a++){let c=Math.floor(i()*s.length),u=Math.floor((s.length-c)*i()),p=new Uint8Array(u),l=new Uint8Array(u);for(let m=0;m<u;m++)l[m]=s[c+m],p[m]=s[c+m]=n++&255;o+=`- arr.set(${c}, [${p.join(", ")}]) -> [${s.join(", ")}]
`,e.makeEdits([{op:2,offset:c,value:p,previous:l}]);try{await t(s)}catch(m){throw console.log(o),m}}}),it("works with multiple replacements",async()=>{e.makeEdits([{op:2,offset:6,value:new Uint8Array([16]),previous:new Uint8Array([6,7,8])},{op:2,offset:1,value:new Uint8Array([11]),previous:new Uint8Array([1,2,3])}]),await t(new Uint8Array([0,11,4,5,16,9]))}),it("overlaps replace on delete",async()=>{e.makeEdits([{op:1,offset:3,previous:new Uint8Array([3,4,5])},{op:2,offset:1,value:new Uint8Array([10,11,12]),previous:new Uint8Array([1,2,6])}]),await t(new Uint8Array([0,10,11,12,7,8,9]))}),it("overlaps replace on insert",async()=>{e.makeEdits([{op:0,offset:2,value:new Uint8Array([10,11,12])},{op:2,offset:1,value:new Uint8Array([20,21,22]),previous:new Uint8Array([1,10,11])}]),await t(new Uint8Array([0,20,21,22,12,2,3,4,5,6,7,8,9]))}),it("delete overlaps multiple",async()=>{e.makeEdits([{op:0,offset:2,value:new Uint8Array([10,11,12])},{op:1,offset:1,previous:new Uint8Array([1,10,11,12,2,3])}]),await t(new Uint8Array([0,4,5,6,7,8,9]))})})})});var Vs,qt,Ir=y(()=>{"use strict";Vs=require("vscode"),qt=r=>typeof Buffer<"u"?Buffer.byteLength(r):new Blob([r]).size});var D,Tr,Ot,w,Pt=y(()=>{"use strict";D=Symbol("Wildcard"),Tr=new Uint8Array(255);for(let r=0;r<255;r++)Tr[r]=r;Ot=new Uint8Array(255);for(let r=0;r<255;r++)Ot[r]=String.fromCharCode(r).toUpperCase().charCodeAt(0);w=class{constructor(e,t,s=Tr){this.needle=e;this.onMatch=t;this.equivalencyTable=s;this.needleLen=0;this.index=0;this.usableBuffer=0;for(let i of e)i===D?this.needleLen++:this.needleLen+=i.length;this.buffer=new Uint8Array(this.needleLen)}push(e){let{needleLen:t,buffer:s}=this;for(let i=0;i<e.length;i++)s[this.index++%t]=e[i],this.usableBuffer++,this.attemptMatch()}attemptMatch(){let{needle:e,needleLen:t,buffer:s,index:i,equivalencyTable:o}=this;if(this.usableBuffer<t)return;let n=0;for(let c=0;c<e.length;c++){let u=e[c];if(u===D){n++;continue}for(let p=0;p<u.length;p++){if(o[u[p]]!==o[s[(i+n)%t]])return;n++}}this.matchTmpBuf||(this.matchTmpBuf=new Uint8Array(t));let a=this.index%t;this.matchTmpBuf.set(s.subarray(a),0),this.matchTmpBuf.set(s.subarray(0,a),t-a),this.onMatch(this.index-t,this.matchTmpBuf),this.usableBuffer=0}}});var Mt,J,Y,Zs,V,qr=y(()=>{"use strict";Ir();Pt();Tt();Mt=class{constructor(e,t){this.filesize=e;this.cap=t;this.buffers=new P;this.fileOffset=0;this.lastYieldedTime=Date.now();this.results=[]}get capped(){return this.cap===0}push(e,t,s){let i=this.buffers.set(e,()=>new Uint8Array(e));this.cap===void 0?this.results.push({from:t,to:s,previous:i}):this.cap>0&&(this.results.push({from:t,to:s,previous:i}),this.cap--)}toYield(){let e=Date.now();if(e-this.lastYieldedTime>Mt.targetUpdateInterval){this.lastYieldedTime=e;let t=this.results;return this.results=[],{progress:this.filesize?this.fileOffset/this.filesize:0,results:t}}}final(){return{progress:1,capped:this.capped,results:this.results}}},J=Mt;J.targetUpdateInterval=1e3;Y=class{constructor(e,t,s,i){this.document=e;this.query=t;this.isCaseSensitive=s;this.cap=i;this.cancelled=!1}dispose(){this.cancelled=!0}async*search(){let{isCaseSensitive:e,query:t,document:s,cap:i}=this,o=new J(await s.size(),i),n=new w(t.literal.map(a=>a==="*"?D:a),(a,c)=>o.push(c,a,a+c.length),e?void 0:Ot);for await(let a of s.readWithEdits(0)){if(this.cancelled||o.capped){yield o.final();return}n.push(a),o.fileOffset+=a.length;let c=o.toYield();c&&(yield c)}yield o.final()}},Zs=8*1024,V=class{constructor(e,t,s,i){this.document=e;this.cap=i;this.cancelled=!1;this.re=new RegExp(t.re,s?"g":"ig")}dispose(){this.cancelled=!0}async*search(){let e="",t=0,{re:s,document:i}=this,o=new TextDecoder,n=new TextEncoder,a=new J(await i.size(),this.cap);for await(let c of i.readWithEdits(0)){if(this.cancelled||a.capped){yield a.final();return}e+=o.decode(c);let u=0;for(let m of e.matchAll(s)){let Bt=t+qt(e.slice(0,m.index)),Wr=qt(m[0]);a.push(n.encode(m[0]),Bt,Bt+Wr),u=m.index+m[0].length}a.fileOffset+=c.length;let p=Math.max(e.length-Zs,u);p>0&&(t+=p,s.lastIndex=0,e=e.slice(p));let l=a.toYield();l&&(yield l)}yield a.final()}}});function Ks(r){for(;r.length;){let e=r.pop();e&&e.dispose()}}var ge,Or=y(()=>{"use strict";ge=class{constructor(){this._isDisposed=!1;this._disposables=[]}dispose(){this._isDisposed||(this._isDisposed=!0,Ks(this._disposables))}_register(e){return this._isDisposed?e.dispose():this._disposables.push(e),e}get isDisposed(){return this._isDisposed}}});var Pr=y(()=>{"use strict"});var xe,Mr=y(()=>{"use strict";Pr();xe=class{start(e,t){this._request?.dispose(),this._request=t,(async()=>{for await(let s of t.search())e.sendEvent({type:2,data:s})})()}cancel(){this._request?.dispose(),this._request=void 0}}});var g,U,Br=y(()=>{"use strict";g=C(require("vscode"));O();Et();Or();Dt();Mr();U=class extends ge{constructor(t,s,i){super();this.model=t;this.isLargeFile=s;this.baseAddress=i;this.lastSave=0;this._selectionState={selected:0};this.searchProvider=new xe;this._onDidDispose=this._register(new g.EventEmitter);this.onDidDispose=this._onDidDispose.event;this._onDidChangeSelectionState=this._register(new g.EventEmitter);this.onDidChangeSelectionState=this._onDidChangeSelectionState.event;this._onDidRevert=this._register(new g.EventEmitter);this.onDidRevert=this._onDidRevert.event}static async create(t,{backupId:s,untitledDocumentData:i},o){let n=await $(t,i),a=new E({accessor:n,isFiniteSize:!0,supportsLengthChanges:!0,edits:s?{unsaved:await new F(g.Uri.parse(s)).read(),saved:[]}:void 0}),c=U.parseQuery(t.query),u=c.baseAddress?U.parseHexOrDecInt(c.baseAddress):0,p=await n.getSize();o.sendTelemetryEvent("fileOpen",{},{fileSize:p??0});let l=g.workspace.getConfiguration().get("hexeditor.maxFileSize")*1e6,m=!s&&!n.supportsIncremetalAccess&&(p??0)>l;return{document:new U(a,m,u),accessor:n}}get pageSize(){return this.model.pageSize}get isReadonly(){return this.model.isReadonly}get uri(){return g.Uri.parse(this.model.uri)}readWithEdits(t){return this.model.readWithEdits(t)}async readBufferWithEdits(t,s){let i=new Uint8Array(s),o=0;for await(let n of this.model.readWithEdits(t)){let a=Math.min(n.length,i.length-o);if(i.set(n.subarray(0,a),o),o+=a,o===s)return i}return i.slice(0,o)}async readBuffer(t,s){let i=new Uint8Array(s),o=await this.model.readInto(t,i);return o===s?i:i.slice(0,o)}dispose(){this._onDidDispose.fire(),this.model.dispose(),super.dispose()}get selectionState(){return this._selectionState}set selectionState(t){this._selectionState=t,this._onDidChangeSelectionState.fire(t)}get isSynced(){return this.model.isSynced}get edits(){return this.model.edits}get unsavedEditIndex(){return this.model.unsavedEditIndex}makeEdits(t){return this.model.makeEdits(t)}insert(t,s){return this.model.makeEdits([{op:0,offset:t,value:s}])}async replace(t,s){let i=await this.readBufferWithEdits(t,s.length);return i.length===s.length?this.makeEdits([{op:2,offset:t,value:s,previous:i}]):this.makeEdits([{op:2,offset:t,value:s.subarray(0,i.length),previous:i},{op:0,offset:t+i.length,value:s.subarray(i.length)}])}size(){return this.model.size()}async save(t){this.lastSave=Date.now(),await this.model.save(),this.lastSave=Date.now()}async saveAs(t,s){if(s&&s.isCancellationRequested)return;if(!this.model.isFiniteSize)throw new Error("Cannot save a document without a finite size");let i=await $(t);this.lastSave=Date.now(),await i.writeStream(this.model.readWithEdits()),this.lastSave=Date.now(),this.model.dispose(),this.model=new E({accessor:i,isFiniteSize:!0,supportsLengthChanges:!0})}async revert(t){this.model.revert(),this._onDidRevert.fire()}async backup(t){return await new F(t).write(this.model.unsavedEdits),{id:t.toString(),delete:async()=>{try{await g.workspace.fs.delete(t)}catch{}}}}static parseQuery(t){let s={};if(t){let i=(t[0]==="?"?t.substr(1):t).split("&");for(let o of i){let n=o.split("="),a=n.shift();a&&(s[a]=n.join("="))}}return s}static parseHexOrDecInt(t){return t=t.toLowerCase(),t.startsWith("0x")?parseInt(t.substring(2),16):parseInt(t,10)}}});var Xs={};var Hr,Lr=y(()=>{"use strict";qr();Hr=require("chai");Br();we();O();describe("searchRequest",async()=>{let r=`Esse in aliqua minim magna dolor tempor eiusmod exercitation ullamco veniam nisi ipsum cillum commodo. Velit ad aliquip dolor sint anim consequat. Excepteur culpa non adipisicing elit tempor laborum tempor qui. Do esse dolore incididunt consequat non excepteur fugiat fugiat veniam deserunt ut pariatur eiusmod. Deserunt irure qui cupidatat laboris.

Irure nulla nulla consequat reprehenderit nisi nulla consequat dolor. Ad consectetur cillum consectetur ea. Reprehenderit esse in in anim mollit laboris eiusmod. Pariatur enim ipsum dolor eiusmod laboris mollit aliqua ullamco laborum fugiat non et. Officia adipisicing duis id sit aliqua et et occaecat. Commodo Lorem laborum aliquip officia ex quis elit elit do qui consectetur dolore.

Lorem ad ullamco ad deserunt voluptate ullamco et in commodo et exercitation duis nisi. Reprehenderit deserunt deserunt eiusmod velit mollit cillum pariatur Lorem exercitation laboris non. Ad eiusmod mollit reprehenderit amet ex elit deserunt cupidatat ullamco ullamco consectetur elit. Laboris duis cupidatat ipsum id anim occaecat pariatur.`,e=async(n,a)=>{let c;for await(let p of n.search())c=p.results.map(l=>({from:l.from,to:l.to,previous:l.previous}));if(!c)throw new Error("no result");let u=p=>p.sort((l,m)=>l.from-m.from).map(l=>({...l,previous:new TextDecoder().decode(l.previous)}));(0,Hr.expect)(u(c)).to.deep.equal(u(a))},t="laboris",s=new TextEncoder().encode(t),i=[{from:341,previous:s,to:348},{from:496,previous:s,to:503},{from:547,previous:s,to:554},{from:915,previous:s,to:922}],o=async(n=r)=>new U(new E({accessor:await be(new TextEncoder().encode(n)),supportsLengthChanges:!1,isFiniteSize:!0}),!1,0);it("searches for literal",async()=>{let n=await o();await e(new Y(n,{literal:[s]},!0,void 0),i)}),it("searches for literal case insensitive",async()=>{let n=await o();await e(new Y(n,{literal:[s]},!1,void 0),[...i,{from:1026,previous:new TextEncoder().encode("Laboris"),to:1033}])}),it("searches for regex",async()=>{let n=await o();await e(new V(n,{re:t},!0,void 0),i)}),it("searches for regex case insensitive",async()=>{let n=await o();await e(new V(n,{re:t},!1,void 0),[...i,{from:1026,previous:new TextEncoder().encode("Laboris"),to:1033}])})})});var ei={};var B,zr=y(()=>{"use strict";B=require("chai");Pt();describe("literal search",()=>{let r=new TextEncoder().encode("Excepteur aliquip sit commodo eiusmod nulla ullamco amet reprehenderit incididunt labore ipsum pariatur non. Laborum labore deserunt incididunt mollit do ex ullamco labore quis occaecat amet. Elit amet laborum et ullamco est labore ea. Ipsum ex laborum officia sit Lorem sint enim fugiat in eu. Exercitation laborum est enim cupidatat irure reprehenderit ea duis elit aliquip anim. Sunt reprehenderit consequat consectetur velit proident cupidatat amet."),e=new TextEncoder().encode("laborum"),t=[{index:202,bytes:"laborum"},{index:245,bytes:"laborum"},{index:308,bytes:"laborum"}],s;beforeEach(()=>{s=[]});let i=(o,n)=>s.push({bytes:new TextDecoder().decode(n),index:o});it("is sane for simple strings",()=>{new w([e],i).push(r),(0,B.expect)(s).to.deep.equal(t)}),it("is sane for wildcards",()=>{new w([new TextEncoder().encode("lab"),D,new TextEncoder().encode("rum")],i).push(r),(0,B.expect)(s).to.deep.equal(t)}),it("is sane for leading wildcards",()=>{new w([D,new TextEncoder().encode("aborum")],i).push(r),(0,B.expect)(s).to.deep.equal([{index:109,bytes:"Laborum"},...t])}),it("works with random wildcards",()=>{for(let o=0;o<e.length;o++)for(let n=1;n<e.length-o;n++){let a=new Uint8Array(e.subarray(0,o)),c=new Array(n).fill(D),u=new Uint8Array(e.subarray(o+n));new w([a,...c,u],i).push(r);for(let l of t)(0,B.expect)(s).to.deep.contain(l);s=[]}}),it("works with random slicing",()=>{for(let o=1;o<100;o++){let n=new w([e],i);for(let a=0;a<r.length;a+=o)n.push(r.subarray(a,a+o));(0,B.expect)(s).to.deep.equal(t),s=[]}})})});var si={};Jr(si,{run:()=>ri});module.exports=Yr(si);var Z=C(require("mocha")),ti=[()=>Promise.resolve().then(()=>(Ar(),Qs)),()=>Promise.resolve().then(()=>(Fr(),Ys)),()=>Promise.resolve().then(()=>(Lr(),Xs)),()=>Promise.resolve().then(()=>(zr(),ei))];async function ri(){let r=new Z.default({ui:"bdd",color:!0});for(let e of ti)r.suite.emit(Z.default.Suite.constants.EVENT_FILE_PRE_REQUIRE,global,e,r),await e(),r.suite.emit(Z.default.Suite.constants.EVENT_FILE_REQUIRE,{},e,r),r.suite.emit(Z.default.Suite.constants.EVENT_FILE_POST_REQUIRE,global,e,r);return new Promise((e,t)=>{r.run(s=>{s>0?t(new Error(`${s} tests failed.`)):e()})})}0&&(module.exports={run});
